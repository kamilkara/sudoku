<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Pro Sudoku - Haptic Edition</title>
    <style>
        :root {
            --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #212529;
            --grid-border: #343a40; --cell-border: #dee2e6; --thick-weight: 2px; 
            --hl-lane: #e8f0fe; --hl-match: #c2dbff; --hl-selected: #7fb5ff;
            --val-fixed: #000000; --val-user: #0056b3; --val-error: #e63946;
        }
        [data-theme='dark'] {
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0;
            --grid-border: #ffffff; --cell-border: #333333; --hl-lane: #2c3e50;
            --hl-match: #34495e; --hl-selected: #1a5fb4; --val-fixed: #ffffff;
            --val-user: #4dabf7; --val-error: #ff6b6b;
        }
        
        html, body { height: 100%; margin: 0; overflow: hidden; }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg-body); color: var(--text-main); 
            display: flex; flex-direction: column; align-items: center;
            padding: 10px; transition: background 0.3s ease; user-select: none;
            box-sizing: border-box;
        }

        .header { display: flex; width: 100%; max-width: 450px; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header-btns { display: flex; gap: 8px; }
        
        .ui-btn { 
            background: var(--bg-card); border: 1px solid var(--cell-border); color: var(--text-main); 
            padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 11px; font-weight: 500;
        }
        .ui-btn.active-picker { background-color: var(--val-user); color: white; border-color: var(--val-user); }

        .timer-row { margin: 5px 0; font-variant-numeric: tabular-nums; font-weight: 600; font-size: 1.1rem; flex-shrink: 0; }

        #grid { 
            display: grid; grid-template-columns: repeat(9, clamp(30px, 10vw, 45px)); 
            grid-template-rows: repeat(9, clamp(30px, 10vw, 45px)); border: var(--thick-weight) solid var(--grid-border); 
            background-color: var(--grid-border); gap: 1px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); flex-shrink: 0;
        }

        .cell { background-color: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; font-weight: 400; }
        .cell:nth-child(3n) { border-right: var(--thick-weight) solid var(--grid-border); }
        .cell:nth-child(9n) { border-right: none; }
        #grid > div:nth-child(n+19):nth-child(-n+27), #grid > div:nth-child(n+46):nth-child(-n+54) { border-bottom: var(--thick-weight) solid var(--grid-border); }

        .hl-lane { background-color: var(--hl-lane); }
        .hl-match { background-color: var(--hl-match) !important; }
        .selected { background-color: var(--hl-selected) !important; }

        .readonly { color: var(--val-fixed); }
        .user-correct { color: var(--val-user); }
        .user-error { color: var(--val-error); }

        .numpad { display: flex; justify-content: center; gap: 4px; width: 100%; max-width: 450px; margin-top: 10px; flex-shrink: 0; }
        .num-btn { 
            flex: 1; aspect-ratio: 1/1.3; background: var(--bg-card); color: var(--text-main); 
            border-radius: 6px; font-size: 1.1rem; font-weight: 600; border: 1px solid var(--cell-border); 
            display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;
        }
        .badge { position: absolute; top: 2px; right: 4px; font-size: 9px; color: var(--text-main); font-weight: 300; opacity: 0.7; }
        .num-btn.active-num { background-color: var(--val-user); color: white; border-color: var(--val-user); }
        .num-btn.completed { background-color: transparent; color: #999; opacity: 0.2; pointer-events: none; border-style: dashed; }
        .num-btn.clear { flex: 1.1; color: var(--val-error); }

        #autoFinishContainer { margin: 10px 0; display: none; flex-shrink: 0; }
        .finish-btn { background-color: #ffc107; color: #000; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        .footer-controls { margin-top: auto; padding-bottom: 20px; flex-shrink: 0; }
        .play-pause-icon { cursor: pointer; opacity: 0.4; width: 45px; height: 45px; fill: var(--text-main); }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 20px; text-align: center; max-width: 320px; }
        .difficulty-options { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .diff-btn { padding: 12px; border: none; border-radius: 10px; background: var(--val-user); color: white; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body data-theme="light">

    <div class="header">
        <h2 style="margin:0; font-size: 1.2rem;">Sudoku</h2>
        <div class="header-btns">
            <button id="pickerBtn" class="ui-btn" onclick="togglePickerMode()">üñäÔ∏è Picker</button>
            <button class="ui-btn" onclick="showNewGameModal()">‚ûï New</button>
            <button class="ui-btn" onclick="toggleTheme()">üåì Theme</button>
        </div>
    </div>

    <div class="timer-row" id="timer">00:00</div>
    <div id="grid"></div>

    <div id="autoFinishContainer">
        <button class="finish-btn" onclick="autoFinishBoard()">ü™Ñ Finish Board (8 left)</button>
    </div>

    <div class="numpad" id="numpad">
        <div class="num-btn" id="btn-1" onclick="handleNumInput(1)">1<span class="badge" id="count-1"></span></div>
        <div class="num-btn" id="btn-2" onclick="handleNumInput(2)">2<span class="badge" id="count-2"></span></div>
        <div class="num-btn" id="btn-3" onclick="handleNumInput(3)">3<span class="badge" id="count-3"></span></div>
        <div class="num-btn" id="btn-4" onclick="handleNumInput(4)">4<span class="badge" id="count-4"></span></div>
        <div class="num-btn" id="btn-5" onclick="handleNumInput(5)">5<span class="badge" id="count-5"></span></div>
        <div class="num-btn" id="btn-6" onclick="handleNumInput(6)">6<span class="badge" id="count-6"></span></div>
        <div class="num-btn" id="btn-7" onclick="handleNumInput(7)">7<span class="badge" id="count-7"></span></div>
        <div class="num-btn" id="btn-8" onclick="handleNumInput(8)">8<span class="badge" id="count-8"></span></div>
        <div class="num-btn" id="btn-9" onclick="handleNumInput(9)">9<span class="badge" id="count-9"></span></div>
        <div class="num-btn clear" onclick="handleNumInput(0)">‚å´</div>
    </div>

    <div class="footer-controls">
        <svg id="pauseIcon" class="play-pause-icon" viewBox="0 0 24 24" onclick="pauseGame()">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </svg>
    </div>

    <div id="gameModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Paused</h2>
            <div class="difficulty-options">
                <button class="diff-btn" id="resumeBtn" onclick="resumeGame()" style="background:#28a745">Resume</button>
                <hr style="width:100%; border:0; border-top:1px solid var(--cell-border); margin:10px 0;">
                <button class="diff-btn" onclick="newGame('easy')">Easy</button>
                <button class="diff-btn" onclick="newGame('normal')">Normal</button>
                <button class="diff-btn" onclick="newGame('hard')">Hard</button>
                <button class="diff-btn" onclick="newGame('expert')">Expert</button>
            </div>
        </div>
    </div>

    <script>
        let solution = [], selectedCell = null, readonlyMap = [], isPickerMode = false, heldNumber = null;
        let seconds = 0, timerInterval = null, isPaused = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Haptic Feedback Logic
        function triggerHaptic(isError = false) {
            if ("vibrate" in navigator) {
                if (isError) {
                    navigator.vibrate([60, 50, 60]); // Double pulse for error
                } else {
                    navigator.vibrate(40); // Single mild pulse
                }
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isPaused) { seconds++; updateTimerDisplay(); if (seconds % 5 === 0) saveGame(); }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${mins}:${secs}`;
        }

        function pauseGame() { isPaused = true; document.getElementById('modalTitle').innerText = "Paused"; document.getElementById('resumeBtn').style.display = 'block'; document.getElementById('gameModal').style.display = 'flex'; }
        function resumeGame() { isPaused = false; document.getElementById('gameModal').style.display = 'none'; }
        function showNewGameModal() { document.getElementById('modalTitle').innerText = "New Game"; document.getElementById('resumeBtn').style.display = 'none'; document.getElementById('gameModal').style.display = 'flex'; }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('sudoku_theme', newTheme);
        }

        function togglePickerMode() { isPickerMode = !isPickerMode; document.getElementById('pickerBtn').classList.toggle('active-picker', isPickerMode); heldNumber = null; clearHighlights(); updateNumpadUI(); }
        function clearHighlights() { document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected', 'hl-lane', 'hl-match')); }

        function saveGame() {
            const currentDigits = Array.from(document.querySelectorAll('.cell')).map(c => c.innerText);
            localStorage.setItem('sudoku_save_data', JSON.stringify({ solution, puzzleState: currentDigits, readonlyMap, seconds }));
        }

        function loadGame() {
            const savedTheme = localStorage.getItem('sudoku_theme');
            if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
            const savedData = localStorage.getItem('sudoku_save_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                solution = data.solution; readonlyMap = data.readonlyMap; seconds = data.seconds || 0;
                updateTimerDisplay(); renderSaved(data.puzzleState); return true;
            }
            return false;
        }

        function playSound(freq, duration = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function newGame(diff) {
            document.getElementById('gameModal').style.display = 'none';
            isPaused = false; seconds = 0; updateTimerDisplay();
            const clues = diff === 'easy' ? 44 : diff === 'normal' ? 36 : diff === 'hard' ? 26 : 19;
            let board = Array.from({length: 9}, () => Array(9).fill(0));
            solve(board); solution = JSON.parse(JSON.stringify(board));
            readonlyMap = Array(81).fill(false);
            let removed = 0;
            while(removed < (81 - clues)) {
                let r = Math.floor(Math.random()*9), c = Math.floor(Math.random()*9);
                if(board[r][c] !== 0) { board[r][c] = 0; removed++; }
            }
            board.flat().forEach((val, i) => { if(val !== 0) readonlyMap[i] = true; });
            renderSaved(board.flat().map(v => v === 0 ? "" : v.toString()));
            startTimer(); saveGame();
        }

        function solve(board) {
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    if (board[r][c] === 0) {
                        let nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
                        for (let n of nums) {
                            if (check(board, r, c, n)) { board[r][c] = n; if (solve(board)) return true; board[r][c] = 0; }
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function check(b, r, c, k) {
            for (let i = 0; i < 9; i++) {
                const m = 3 * Math.floor(r / 3) + Math.floor(i / 3), n = 3 * Math.floor(c / 3) + i % 3;
                if (b[r][i] == k || b[i][c] == k || b[m][n] == k) return false;
            }
            return true;
        }

        function renderSaved(flatDigits) {
            const grid = document.getElementById('grid'); grid.innerHTML = '';
            flatDigits.forEach((val, i) => {
                const div = document.createElement('div'); div.className = 'cell';
                div.dataset.r = Math.floor(i / 9); div.dataset.c = i % 9;
                div.innerText = val;
                if (readonlyMap[i]) div.classList.add('readonly');
                else if (val !== "") div.classList.add(val == solution[div.dataset.r][div.dataset.c] ? 'user-correct' : 'user-error');
                div.onclick = () => onCellClick(div); grid.appendChild(div);
            });
            updateNumpadUI();
        }

        function updateNumpadUI() {
            const counts = {}; for (let i = 1; i <= 9; i++) counts[i] = 0;
            let correctCount = 0; let totalFilled = 0;
            document.querySelectorAll('.cell').forEach(cell => {
                const val = parseInt(cell.innerText), r = cell.dataset.r, c = cell.dataset.c;
                if (val && val == solution[r][c]) { counts[val]++; correctCount++; }
                if (val) totalFilled++;
            });
            for (let i = 1; i <= 9; i++) {
                const btn = document.getElementById(`btn-${i}`);
                const badge = document.getElementById(`count-${i}`);
                const remaining = 9 - counts[i];
                badge.innerText = remaining > 0 ? remaining : "";
                btn.classList.remove('active-num', 'completed');
                if (remaining === 0) { btn.classList.add('completed'); if (heldNumber === i) heldNumber = null; }
                else if (isPickerMode && heldNumber === i) btn.classList.add('active-num');
            }
            const remainToFinish = 81 - totalFilled;
            document.getElementById('autoFinishContainer').style.display = (remainToFinish === 8) ? 'block' : 'none';
            if (correctCount === 81) { 
                isPaused = true; 
                document.getElementById('modalTitle').innerText = "Winner! Time: " + document.getElementById('timer').innerText; 
                document.getElementById('resumeBtn').style.display = 'none'; 
                document.getElementById('gameModal').style.display = 'flex'; 
            }
        }

        function autoFinishBoard() {
            document.querySelectorAll('.cell').forEach(cell => {
                const r = cell.dataset.r, c = cell.dataset.c;
                if (!cell.innerText || cell.classList.contains('user-error')) {
                    cell.innerText = solution[r][c];
                    cell.className = 'cell user-correct';
                }
            });
            triggerHaptic(false);
            updateNumpadUI();
            saveGame();
        }

        function onCellClick(cell) {
            if (isPaused) return;
            if (isPickerMode) {
                if (cell.classList.contains('readonly') || (cell.innerText !== "" && cell.classList.contains('user-correct'))) {
                    const clickedVal = parseInt(cell.innerText);
                    const btn = document.getElementById(`btn-${clickedVal}`);
                    if (btn && !btn.classList.contains('completed')) heldNumber = clickedVal;
                } else if (heldNumber !== null) inputNumberIntoCell(cell, heldNumber);
            }
            highlight(cell); updateNumpadUI();
        }

        function highlight(cell) {
            clearHighlights(); selectedCell = cell; cell.classList.add('selected');
            const r = cell.dataset.r, c = cell.dataset.c, val = cell.innerText;
            document.querySelectorAll('.cell').forEach(item => {
                if (item.dataset.r === r || item.dataset.c === c) item.classList.add('hl-lane');
                if (val && item.innerText === val) item.classList.add('hl-match');
            });
        }

        function handleNumInput(n) {
            if (isPaused) return;
            if (isPickerMode && n !== 0) {
                const btn = document.getElementById(`btn-${n}`);
                if (!btn.classList.contains('completed')) heldNumber = n;
            } else if (selectedCell) inputNumberIntoCell(selectedCell, n);
            updateNumpadUI(); if (selectedCell) highlight(selectedCell);
        }

        function inputNumberIntoCell(cell, n) {
            if (cell.classList.contains('readonly')) return;
            const r = cell.dataset.r, c = cell.dataset.c;
            if (n === 0) { 
                cell.innerText = ''; cell.className = 'cell selected'; playSound(200); 
            } else {
                const isCorrect = (n == solution[r][c]); 
                cell.innerText = n;
                cell.className = `cell selected ${isCorrect ? 'user-correct' : 'user-error'}`;
                playSound(isCorrect ? 600 : 150);
                triggerHaptic(!isCorrect); // Haptic feedback
            }
            saveGame();
        }

        if (!loadGame()) newGame('normal'); else startTimer();
    </script>
</body>
</html>
